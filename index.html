<!DOCTYPE html>
<html lang="en">
<head>
  <title>Arcom Control Panel</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https:/arcom.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
  <script src="https:/jquery.xmlrpc.js"></script>
  <script>
    var call = "Unknown";
    var place = "Unknown";

    function setTitle(response, status, jqXHR){
      var identity = response;
      $("#title").html('Repeater Control - '+identity);
    }

    function updateStatus(response, status, jqXHR){
      updateResponse(response, status, jqXHR);
      callRPC("status", [call], setStatus);
    }

    function setStatusTitle(){
      $("#statusTitle").html("Operator: " + $.cookie("arcom.call") +
                             " @ " + $.cookie("arcom.location"));
    }

    function setStatus(response, status, jqXHR){
      var html = '';
      var obj = response[0]

      setStatusTitle();
      html = '<table class=\"table table-condensed\"><tbody>'
      for (var item in obj) {
	if (item == "auto-enable") {
	  html += "<tr><td>" + item + "</td><td>" +
	          Date(obj[item].toFixed(0)*1000) + "</td></tr>";
	} else
          html += "<tr><td>" + item + "</td><td>" + obj[item] + "</td></tr>";
      }
      html += "</tbody></table>";
      $("#status-content").html(html);
    }

    function callRPC(func, params, callback){
      var rpcURL = "https:/RPC2";

      if (!callback) callback = updateResponse;

      $.xmlrpc({
        url: rpcURL,
        methodName: func,
        params: params,
        success: callback,
        error: function(jqXHR, status, error) { alert("RPC FAIL: " + func + ": " + status + ": " + error) }
      });
    };

    function updateResponse(response, status, jqXHR) {
      var tuple = response[0];
      setResponse('RPC ' + status + ': Command ' + tuple[0] + ': ' + tuple[1]);
    }

    function setResponse(text) {
      $("#response").html('<div class="well well-sm">' + text + '</div>');
    }

    function listLog(response, status, jqXHR){
      var html = '';
      var obj = response[0]

      html = '<table class=\"table table-condensed\"><tbody>'
      for (var item in obj) {
	var entry = obj[item];
        html += "<tr><td>" + Date(entry[0].toFixed(0)*1000) + "</td><td>" +
                entry[1] + "</td><td>" + entry[2] + "</td></tr>";
      }
      html += "</tbody></table>";
      $("#response").html(html);
    }

    function disableAndLog(call, mins){
      callRPC("port1Disable", [call, mins], updateStatus);
      callRPC("logInterference", [call, place, mins]);
    }

    function checkCookies(){
      if ($.cookie("arcom.call") == null || $.cookie("arcom.location") == null)
        setCookies();
      call = $.cookie("arcom.call");
      place = $.cookie("arcom.location");
      setStatusTitle();
    }

    function setCookies(){
      bootbox.prompt({ 
        size: "small",
        title: "What is your call?",
        callback: function(result){
          if (result != null) $.cookie("arcom.call", result.toUpperCase(), { expires: 365 });
          bootbox.prompt({
            title: "What is your location? (e.g. grid square)",
            callback: function(result){
              if (result != null) $.cookie("arcom.location", result, { expires: 365 });
              setStatusTitle();
              setResponse('Call=' + $.cookie("arcom.call") +
                          '  Location=' + $.cookie("arcom.location"));
            }
          });
        }
      });
    }

    $(document).ready(function(){
      checkCookies();
      callRPC("getIdentity", [call], setTitle);
      callRPC("status", [call], setStatus);
      $("#port1Disable5").bind('click', function (){
          bootbox.confirm("Confirm disable?", function(result){
              if (result) disableAndLog(call, 300);
          })
      });
      $("#port1Disable10").bind('click', function (){
          bootbox.confirm("Confirm disable?", function(result){
              if (result) disableAndLog(call, 600);
          })
      });
      $("#port1Disable15").bind('click', function (){
          bootbox.confirm("Confirm disable?", function(result){
              if (result) disableAndLog(call, 900);
          })
      });
      $("#port1Disable").bind('click', function (){
          bootbox.confirm("Confirm disable?", function(result){
              if (result) callRPC("port1Disable", [call, 0], updateStatus);
          })
      });
      $("#port1Enable").bind('click', function (){callRPC("port1Enable", [call], updateStatus)});
      $("#port3Unbridge").bind('click', function (){
          bootbox.confirm("Confirm unbridging 1 & 3?", function(result){
              if (result) callRPC("port3Unbridge", [call], updateStatus);
          })
      });
      $("#port3Bridge").bind('click', function (){callRPC("port3Bridge", [call], updateStatus)});
      $("#setDateTime").bind('click', function (){
          bootbox.confirm("Confirm setting date/time?", function(result){
              if (result) callRPC("setDateTime", [call]);
          })
      });
      $("#getIdentity").bind('click', function (){callRPC("getIdentity", [call], setTitle)});
      $("#getStatus").bind('click', function (){callRPC("status", [call], setStatus)});
      $("#getLog").bind('click', function (){callRPC("getLog", [call, 10], listLog)});
      $("#logInterference").bind('click', function (){
          bootbox.confirm("Confirm logging?", function(result){
              if (result) callRPC("logInterference", [call, place, 300]);
          })
      });
      $("#setViolator").bind('click', function (){
          bootbox.prompt({
            title: "Select violator",
            inputType: 'select',
            inputOptions: [
              { text: 'Violator Alpha (falsetto)',
                value: 'Violator Alfa (High pitched, falsetto, singing, swearing)', },
              { text: 'Violator Beta (Doubler)',
                value: 'Violator Bravo ("Doubler", doubles with net checkins, occasional other comments)', },
              { text: 'Violator Charlie',
                value: 'Violator Charlie (some third person)', },
              { text: 'Someone else', value: 'other', }
            ],
            callback: function (result) {
              if (result != null) callRPC("setViolator", [call, result]);
              else setResponse("No change.");
            }
         });
      });
      $("#setCookies").bind('click', function (){ setCookies(); });
    })
  </script>
</head>

<body>
<div class="container">
  <div id="header" class="row">
    <h3><div id="title"><h3>Repeater Control</div></h3>
    <h4><div id="statusTitle"Control Op ...</div></h4>
    <div class="col-sm-4">
      <div id="status-content"></div>
    </div>
  </div>
  <div class="row">
    <h4>Commands</h4>
    <div id="menu1" class="btn-group-vertical" class="btn-group-xs" class="col-sm-4">
      <button type="button" class="btn btn-danger"
	      id="port1Disable5">Port 1 Disable for 5 minutes</button><br>
      <button type="button" class="btn btn-danger"
	      id="port1Disable10">Port 1 Disable for 10 minutes</button><br>
      <button type="button" class="btn btn-danger"
	      id="port1Disable15">Port 1 Disable for 15 minutes</button><br>
      <button type="button" class="btn btn-danger"
	      id="port1Disable">Port 1 Disable</button><br>
      <button type="button" class="btn btn-danger"
	      id="port3Unbridge">Unbridge Port 1-to-3</button><br>
      <button type="button" class="btn btn-danger"
	      id="restart">Restart</button><br>
      <button type="button" class="btn btn-warning"
	      id="setDateTime">Set Date & Time</button><br>
    </div> 
    <div id="menu2" class="btn-group-vertical" class="btn-group-xs" class="col-sm-4">
      <button type="button" class="btn btn-info"
	      id="getIdentity">Identity</button><br>
      <button type="button" class="btn btn-info"
	      id="getStatus">Status</button><br>
      <button type="button" class="btn btn-info"
	      id="getLog">Recent Activity</button><br>
      <button type="button" class="btn btn-success"
	      id="port1Enable">Port 1 Enable</button><br>
      <button type="button" class="btn btn-success"
	      id="port3Bridge">Bridge Port 1-to-3</button><br>
      <button type="button" class="btn btn-warning"
	      id="setViolator">Set Violator</button><br>
      <button type="button" class="btn btn-info"
	      id="setCookies">Set Cookies</button><br>
    </div>
  </div>
  <div id="response" class="row"></div>
</div>

</body>
</html>
